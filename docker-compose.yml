services:
  paper-summarizer:
    # 使用本地构建，不依赖远程镜像
    build:
      context: .
      dockerfile: Dockerfile
    container_name: paper-summarizer
    ports:
      - "18860:7860"
    volumes:
      # 挂载输出目录（持久化生成的摘要）
      - ./summaries:/app/summaries
      # 使用命名卷持久化config.json
      - config-data:/app/data
    environment:
      # 从.env文件读取API配置（可选，作为默认值）
      - API_KEY=${API_KEY:-}
      - BASE_URL=${BASE_URL:-}
      - MODEL=${MODEL:-gemini-2.5-flash}
      - TZ=Asia/Shanghai
      # Gradio 配置优化
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:7860', timeout=5)"]
      interval: 60s  # 增加间隔，减少健康检查频率
      timeout: 15s  # 增加超时时间
      retries: 5  # 增加重试次数
      start_period: 30s  # 给应用更多启动时间
    deploy:
      resources:
        limits:
          memory: 2G  # 限制最大内存
        reservations:
          memory: 512M  # 保留最小内存
    networks:
      - paper-network

networks:
  paper-network:
    driver: bridge

volumes:
  config-data:
